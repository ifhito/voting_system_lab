<html>
  <head>
    <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.0.0/firebase-firestore.js"></script>
    <script type="text/javascript" src="/read_firebase.js"></script>
    <script type="text/javascript" src="/utils_lib.js"></script>
    <!--Load the AJAX API-->
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
  </head>

  <body>
    <script type="text/javascript">
      // Load the Visualization API and the corechart package.
      google.charts.load("current", { packages: ["corechart"] });
      let presentor_result = new Map();
      let facilitator_result = new Map();
      async function drawAllChart(data) {
        let vote_data = data;
        for (var voters_id in vote_data) {
          for (var voted_id in vote_data[voters_id]) {
            //console.log(vote_data[voters_id][voted_id]["vote_rank"]);
            if (vote_data[voters_id][voted_id]["role"] == "Presentor") {
              console.log(vote_data);
              if (presentor_result.has(voted_id)) {
                console.log("pp")
                let presen = presentor_result.get(voted_id);
                presentor_result.set(
                  voted_id,
                  presen.concat(vote_data[voters_id][voted_id]["vote_rank"])
                );
              } else {
                console.log("p", presentor_result);
                presentor_result.set(voted_id, [
                  vote_data[voters_id][voted_id]["vote_rank"]
                ]);
              }
            } else if (vote_data[voters_id][voted_id]["role"] == "Facilitator"){
              if (facilitator_result.has(voted_id)) {
                let facili = facilitator_result.get(voted_id);
                facilitator_result.set(
                  voted_id,
                  facili.concat(vote_data[voters_id][voted_id]["vote_rank"])
                );
              } else {
                console.log("fg",facilitator_result);
                facilitator_result.set(voted_id, [
                  vote_data[voters_id][voted_id]["vote_rank"]
                ]);
              }
            }
          }
        }

        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(
          drawChart(presentor_result, "chart_div")
        );
        google.charts.setOnLoadCallback(
          drawChart(facilitator_result, "chart_div2")
        );
      }

      // Callback that creates and populates a data table,
      // instantiates the pie chart, passes in the data and
      // draws it.
      function drawChart(result, locate) {
        let table = [[]];
        let i = 0;
        console.log(result);
        result.forEach((value, key) => {
          table[0].push("");
          value.push("");
          table.push([key].concat(value));
          table[i + 1].concat(value.push(""));
          i += 1;
        });
        table[0].pop(1);
        table[0].push({ role: "annotation" });
        console.log(table);
        var data = google.visualization.arrayToDataTable(table);

        var options = {
          width: 600,
          height: 400,
          legend: { position: "top", maxLines: 3 },
          bar: { groupWidth: "75%" },
          isStacked: true
        };
        // Instantiate and draw our chart, passing in some options.
        var chart = new google.visualization.BarChart(
          document.getElementById(locate)
        );
        chart.draw(data, options);
      }

      //drawAllChart(null);

      db.collection("vote_data")
        .doc(getTodayTimestamp().toString())
        .onSnapshot(doc => {
          doc_data = doc.data();
          drawAllChart(doc_data);
          // console.log(p, fg);
        });

    </script>
    <!--Div that will hold the pie chart-->
    <div id="chart_div"></div>
    <div id="chart_div2"></div>
  </body>
</html>
